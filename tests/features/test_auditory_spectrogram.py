import pytest
import numpy as np

from naplib.features import auditory_spectrogram

@pytest.fixture(scope='module')
def small_sound():
    fs = 10000
    t = 1
    f = 800
    samples = np.linspace(0, t, int(fs*t), endpoint=False)
    signal = np.sin(2 * np.pi * f * samples)
    return signal

def test_compare_matlab_small_sound_linear_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='linear')
    aud_truth_last_row = np.array([
        1.27928018e-02, 4.51447116e-03, 4.36261937e-03, 1.77458688e-02,
        1.21789858e-02, 3.64274732e-03, 5.28986693e-03, 2.00458812e-02,
        2.62576760e-03, 1.69451982e-02, 2.87424096e-02, 1.14634475e-02,
        2.36022639e-02, 6.74908680e-03, 5.74352916e-03, 2.41567678e-02,
        3.56551035e-03, 4.60669437e-02, 2.36225199e-03, 1.64684299e-02,
        1.53798446e-02, 4.40162089e-03, 3.20258718e-02, 1.44737943e-02,
        1.85256527e-02, 1.49915193e-02, 2.55422906e-02, 2.14890558e-02,
        1.43283886e-02, 3.75687036e-02, 2.09927177e-02, 3.67271903e-02,
        3.15959545e-02, 3.40593079e-02, 3.82219775e-02, 4.26832764e-02,
        4.86843968e-02, 5.68977918e-02, 6.48824911e-02, 6.94994937e-02,
        7.79052626e-02, 1.11196692e-01, 1.34315217e-01, 1.60211145e-01,
        2.01839483e-01, 2.42410225e-01, 2.32127289e-01, 2.70607298e-01,
        1.19154514e+00, 6.34516828e+00, 1.84818890e+01, 1.48572439e+01,
        8.93880550e+00, 6.26666761e+00, 4.37936605e+00, 3.06861344e+00,
        2.40551354e+00, 1.93318073e+00, 1.53610938e+00, 1.30309084e+00,
        1.11416365e+00, 9.53989148e-01, 8.27751269e-01, 7.09117956e-01,
        6.23569636e-01, 5.45829743e-01, 4.55091561e-01, 4.19082357e-01,
        4.13569151e-01, 2.38741276e-01, 3.74384802e-01, 2.73229005e-01,
        2.28883622e-01, 2.08822743e-01, 1.45978414e-01, 2.11326607e-01,
        2.44501683e-01, 1.45724580e-01, 1.34216430e-01, 1.23946404e-01,
        1.99810682e-01, 4.60928673e-02, 9.95061325e-02, 9.25507586e-02,
        8.66554132e-02, 8.25205197e-02, 7.81135697e-02, 7.42583575e-02,
        7.07469325e-02, 6.76489907e-02, 6.21227668e-02, 6.49452111e-02,
        5.78290282e-02, 5.54979322e-02, 5.90085766e-02, 5.24885852e-02,
        5.28363665e-02, 4.89261203e-02, 5.22956216e-02, 4.84164153e-02,
        4.85396659e-02, 4.49204621e-02, 4.74613301e-02, 4.31650609e-02,
        4.58634118e-02, 5.51753428e-02, 1.17658116e-01, 5.12281451e-02,
        4.50608348e-02, 4.39799057e-02, 4.26000131e-02, 4.82993789e-02,
        4.39596775e-02, 4.28951582e-02, 4.32033345e-02, 4.32315203e-02,
        4.37074416e-02, 4.53971977e-02, 4.29908982e-02, 4.58517154e-02,
        4.48700132e-02, 4.63546671e-02, 4.58461330e-02, 4.76959302e-02,
        4.83011382e-02, 4.97950664e-02, 5.21061152e-02, 5.79194538e-02,
    ])
    assert np.allclose(aud[-1,:], aud_truth_last_row, rtol=1e-6)

def test_compare_matlab_small_sound_halfwave_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor='half-wave')
    aud_truth_last_row = np.array([
        1.99844472e-097, 1.57427427e-002, 1.57235748e-094, 3.11584738e-099,
        1.55042873e-098, 1.48679175e-002, 3.24217670e-002, 1.54074480e-100,
        3.95408348e-003, 1.22141995e-100, 9.26189621e-102, 9.37705692e-002,
        2.81301719e-102, 9.61295247e-100, 5.01919962e-002, 2.05490952e-102,
        3.00616182e-002, 7.32993503e-104, 1.89657526e-002, 1.34909908e-102,
        1.08522753e-102, 1.07210776e-101, 6.98617989e-104, 2.80659193e-103,
        1.48900347e-103, 1.06953255e-103, 7.44392348e-104, 2.35776956e-104,
        2.04232400e-103, 9.71807063e-105, 1.70782167e-104, 4.64460449e-105,
        6.14462057e-105, 3.90037093e-105, 3.12327577e-105, 2.45261671e-105,
        2.04909795e-105, 1.20504394e-105, 7.73416760e-106, 7.65229648e-106,
        6.04916989e-106, 4.32245573e-106, 3.19493493e-106, 3.05400243e-106,
        2.36429257e-106, 2.48006031e-106, 3.08761582e-106, 4.07609365e-002,
        9.81548774e-001, 7.05576419e-110, 1.59176205e-109, 2.83584365e+001,
        2.60174742e+001, 2.17057229e+001, 1.92576286e+001, 1.39391991e+001,
        1.10722871e+001, 9.46049300e+000, 7.77328374e+000, 6.77138942e+000,
        6.28642404e+000, 4.72869920e+000, 5.04608459e+000, 4.49611490e+000,
        3.41185705e+000, 3.35807998e+000, 3.19888405e+000, 3.27116502e+000,
        2.15015876e+000, 1.80426332e+000, 1.94708598e+000, 1.91314280e+000,
        1.58397695e+000, 1.44846777e+000, 5.48385704e-001, 1.28825938e+000,
        1.92534162e+000, 9.32405955e-001, 8.79750350e-001, 8.30743274e-001,
        1.21186582e+000, 3.16761185e-001, 7.06270701e-001, 6.70081644e-001,
        6.36436103e-001, 6.10567070e-001, 5.82960840e-001, 5.58762342e-001,
        5.36717373e-001, 4.66059790e-001, 4.09939594e-001, 4.41438148e-001,
        3.97607475e-001, 3.88094648e-001, 4.28172214e-001, 3.80783719e-001,
        3.89682051e-001, 3.60602597e-001, 3.98165872e-001, 3.68277841e-001,
        3.76700092e-001, 3.44769051e-001, 3.73914502e-001, 3.35960808e-001,
        3.61287844e-001, 2.06533031e-001, 6.23976820e-001, 2.29379243e-001,
        3.53208208e-001, 3.41986498e-001, 3.35497744e-001, 3.73721675e-001,
        2.94436221e-001, 3.31240169e-001, 3.33966918e-001, 3.27160259e-001,
        3.31665727e-001, 3.51410401e-001, 3.05796086e-001, 2.96301917e-001,
        2.72272756e-001, 2.86565585e-001, 2.72743796e-001, 2.89312153e-001,
        2.03930542e-001, 1.99012821e-001, 2.11393990e-001, 1.27600267e-001,
    ])
    assert np.allclose(aud[-1,:], aud_truth_last_row, rtol=1e-6)

def test_compare_matlab_small_sound_point1_factor(small_sound):
    aud = auditory_spectrogram(small_sound, 10000, frame_len=8, tc=4, factor=0.1)
    aud_truth_100th_row = np.array([
        9.22532975e-02, 3.62356565e-02, 3.17171214e-02, 1.27044137e-01,
        8.77029586e-02, 2.97735645e-02, 4.41239352e-02, 1.43976068e-01,
        2.00713942e-02, 1.21964397e-01, 2.06228996e-01, 9.44485796e-02,
        1.69774449e-01, 4.82810100e-02, 4.75249157e-02, 1.71767475e-01,
        2.93112059e-02, 3.24121728e-01, 1.94454198e-02, 1.17277179e-01,
        1.08586943e-01, 3.23268581e-02, 2.25152120e-01, 1.03606781e-01,
        1.31940491e-01, 1.06749733e-01, 1.79760622e-01, 1.53212667e-01,
        1.09147967e-01, 2.62937726e-01, 1.53045218e-01, 2.56768708e-01,
        2.22228282e-01, 2.41015407e-01, 2.73016725e-01, 3.07571104e-01,
        3.49826766e-01, 4.07752419e-01, 4.62125185e-01, 5.05380315e-01,
        5.36523204e-01, 7.78541019e-01, 9.30619202e-01, 1.12364584e+00,
        1.34260257e+00, 1.55178518e+00, 1.49687074e+00, 1.99036274e+00,
        8.92313211e+00, 1.81148150e+01, 4.11507726e+01, 3.23052419e+01,
        2.18486942e+01, 1.65113073e+01, 1.23931110e+01, 9.38950751e+00,
        7.87754107e+00, 6.80810159e+00, 5.57579123e+00, 5.01447129e+00,
        4.50317669e+00, 4.03146913e+00, 3.48375150e+00, 3.01602330e+00,
        2.73104410e+00, 2.45118033e+00, 1.92844694e+00, 1.70173285e+00,
        2.27381533e+00, 9.34951112e-01, 2.08640295e+00, 1.33065329e+00,
        1.18399737e+00, 1.12334987e+00, 9.99986616e-01, 1.14809763e+00,
        1.20717347e+00, 8.13159239e-01, 7.56260803e-01, 7.03934809e-01,
        1.23273105e+00, 2.84276780e-01, 5.92978422e-01, 5.59667958e-01,
        5.29019518e-01, 5.06083551e-01, 4.80068216e-01, 4.57072885e-01,
        4.35746125e-01, 4.19779461e-01, 3.89469267e-01, 4.11701610e-01,
        3.69902508e-01, 3.58111521e-01, 3.81477193e-01, 3.41656100e-01,
        3.41868153e-01, 3.18548476e-01, 3.44119671e-01, 3.20203255e-01,
        3.25486370e-01, 3.01199189e-01, 3.20927471e-01, 2.93809131e-01,
        3.11901373e-01, 3.99497440e-01, 9.08471779e-01, 3.62076046e-01,
        3.21006468e-01, 3.13400695e-01, 3.04275010e-01, 3.37275397e-01,
        3.30255264e-01, 3.08362876e-01, 3.11478441e-01, 3.15093388e-01,
        3.18587003e-01, 3.29671293e-01, 3.24246134e-01, 3.37094875e-01,
        3.36425204e-01, 3.46215599e-01, 3.46472077e-01, 3.58923246e-01,
        3.65381032e-01, 3.77565111e-01, 3.87541651e-01, 4.43105547e-01,
    ])
    assert np.allclose(aud[99,:], aud_truth_100th_row, rtol=1e-6)

